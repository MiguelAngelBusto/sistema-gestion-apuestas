<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Betflow - Generador de Reportes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; padding: 40px; }
        .config-card { background: #1e1e1e; padding: 25px; border-radius: 12px; max-width: 600px; margin: auto; border: 1px solid #333; }
        .group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #aaa; }
        select, input { width: 100%; padding: 10px; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 4px; box-sizing: border-box; }
        .btn-generate { width: 100%; padding: 15px; background: #007bff; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1rem; }
        .btn-generate:hover { background: #0056b3; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .checkbox-group input { width: auto; }
        /* Canvas oculto para renderizar el gráfico del PDF */
        #tempChartCanvas { display: none; }
    </style>
</head>
<body>

    <div class="config-card">
        <h2 style="margin-top:0">Configuración del Reporte</h2>
        
        <div class="group">
            <label>Tipo de Filtro</label>
            <select id="tipoFiltro" onchange="toggleInputs()">
                <option value="mes">Por Mes</option>
                <option value="rango">Rango de Fechas</option>
            </select>
        </div>

        <div id="input-mes" class="group">
            <label>Seleccionar Mes</label>
            <input type="month" id="filtroMes">
        </div>

        <div id="input-rango" class="group" style="display:none">
            <div style="display: flex; gap: 10px;">
                <div style="flex:1">
                    <label>Desde</label>
                    <input type="date" id="fechaDesde">
                </div>
                <div style="flex:1">
                    <label>Hasta</label>
                    <input type="date" id="fechaHasta">
                </div>
            </div>
        </div>

        <div class="group">
            <label class="checkbox-group">
                <input type="checkbox" id="incluirMovimientos" checked> 
                Incluir detalle de movimientos (Hoja 2)
            </label>
        </div>

        <button class="btn-generate" onclick="generarReporte()">Descargar Reporte PDF</button>
    </div>

    <canvas id="tempChartCanvas" width="800" height="400"></canvas>

    <script>
        let todasLasApuestas = [];

        window.onload = async () => {
    const userId = localStorage.getItem('userId');
    if (!userId) {
        alert("Sesión no encontrada. Reingresa por favor.");
        window.location.href = "index.html";
        return;
    }
    
    // Cambiamos a la ruta correcta que definimos antes
    // Agregamos un console.log para ver qué llega
    try {
        const response = await fetch(`/api/bets/historial/${userId}?page=0&size=10000`);
        const res = await response.json();
        todasLasApuestas = res.data || [];
        if(todasLasApuestas.length > 0) {
        console.log("Estructura real de una apuesta:", todasLasApuestas[0]);
    }
        console.log(`✅ Se cargaron ${todasLasApuestas.length} apuestas.`);
    } catch (e) {
        console.error("Error cargando historial:", e);
    }
};

        function toggleInputs() {
            const tipo = document.getElementById('tipoFiltro').value;
            document.getElementById('input-mes').style.display = tipo === 'mes' ? 'block' : 'none';
            document.getElementById('input-rango').style.display = tipo === 'rango' ? 'block' : 'none';
        }

        function obtenerFechaLocal(fechaStr) {
            const partes = fechaStr.split('T')[0].split('-');
            return new Date(partes[0], partes[1] - 1, partes[2]);
        }

async function generarReporte() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const tipo = document.getElementById('tipoFiltro').value;
    
    let filtradas = [];
    let textoPeriodo = "";

    if(tipo === 'mes') {
        const mesVal = document.getElementById('filtroMes').value; // Ejemplo: "2026-02"
        if (!mesVal) return alert("Por favor, selecciona un mes");

        textoPeriodo = `Mes: ${mesVal}`;
        
        filtradas = todasLasApuestas.filter(b => {
            // Extraemos solo el YYYY-MM de la fecha de la apuesta
            const fechaLimpia = b.fecha.substring(0, 7); 
            return fechaLimpia === mesVal;
        });
    } else {
        const desde = document.getElementById('fechaDesde').value; // "YYYY-MM-DD"
        const hasta = document.getElementById('fechaHasta').value;
        
        if (!desde || !hasta) return alert("Selecciona ambas fechas");

        textoPeriodo = `Rango: ${desde} al ${hasta}`;
        
        filtradas = todasLasApuestas.filter(b => {
            // Cortamos la fecha de la apuesta para que sea solo YYYY-MM-DD
            const fechaApuesta = b.fecha.split('T')[0]; 
            return fechaApuesta >= desde && fechaApuesta <= hasta;
        });
    }

    // DEBUG: Para ver en consola cuántas pasaron el filtro
    console.log(`Filtradas para el reporte: ${filtradas.length} de ${todasLasApuestas.length}`);

    if(filtradas.length === 0) {
        return alert("No hay datos que coincidan con el filtro seleccionado.");
    }    filtradas.sort((a,b) => a.nro_movimiento - b.nro_movimiento);

    // 2. Cálculos (igual que antes)
    let apostado = 0, neta = 0, ganadas = 0;
    filtradas.forEach(b => {
        const monto = parseFloat(b.dinero);
        apostado += monto;
        const esGanador = b.resultados?.resultado === 'Ganador';
        neta += esGanador ? (monto * parseFloat(b.cuota) - monto) : -monto;
        if(esGanador) ganadas++;
    });

    // 3. Diseño Hoja 1
    doc.setFontSize(20);
    doc.setTextColor(40, 40, 40);
    doc.text("REPORTE DE RENDIMIENTO", 20, 22);
    
    doc.setFontSize(11);
    doc.setTextColor(100, 100, 100);
    doc.text(textoPeriodo.toUpperCase(), 20, 30); // Aquí se muestra el rango de fechas
    
    doc.setDrawColor(200, 200, 200);
    doc.line(20, 35, 190, 35);

    // Bloque de Stats con mejor alineación
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);
    doc.text("RESUMEN DE CUENTA", 20, 48);
    
    doc.setFontSize(10);
    doc.text(`Total Apostado: $${apostado.toLocaleString()}`, 25, 58);
    doc.text(`Ganancia Neta: $${neta.toLocaleString()}`, 25, 65);
    doc.text(`Tasa Efectividad: ${((ganadas/filtradas.length)*100).toFixed(1)}%`, 110, 58);
    doc.text(`Cantidad Apuestas: ${filtradas.length}`, 110, 65);

    // 4. Imagen del Gráfico Profesional
    const chartImg = await crearImagenGrafico(filtradas);
    doc.addImage(chartImg, 'PNG', 15, 75, 180, 90);

   if (document.getElementById('incluirMovimientos').checked) {
        doc.addPage(); // Forzamos una nueva hoja
        
        doc.setFontSize(16);
        doc.text("DETALLE DE MOVIMIENTOS", 20, 20);

const filasTabla = filtradas.map(b => {
    const monto = parseFloat(b.dinero || 0);
    const cuota = parseFloat(b.cuota || 0);
    const esGanador = b.resultados?.resultado === 'Ganador';
    
    // Cálculo de la ganancia de esta apuesta
    const gananciaIndividual = esGanador ? monto * (cuota - 1) : -monto;

    return [
        `M${b.nro_movimiento}`,
        b.fecha.split('T')[0],
        `${b.local?.nombre || 'S/D'} vs ${b.visitante?.nombre || 'S/D'}`,
        `$${monto.toLocaleString('es-AR', {minimumFractionDigits: 2})}`,
        cuota.toFixed(2),
        { 
            content: `$${gananciaIndividual.toLocaleString('es-AR', {minimumFractionDigits: 2})}`,
            styles: { textColor: esGanador ? [0, 128, 0] : [200, 0, 0] } // Verde si gana, rojo si pierde
        },
        b.resultados?.resultado || 'Pendiente'
    ];
});

doc.autoTable({
    startY: 30,
    head: [['Mov', 'Fecha', 'Evento', 'Monto', 'Cuota', 'Ganancia', 'Resultado']],
    body: filasTabla,
    theme: 'striped',
    headStyles: { fillColor: [44, 62, 80], halign: 'center' },
    styles: { fontSize: 7, cellPadding: 2 },
    columnStyles: {
        0: { cellWidth: 10 }, 
        1: { cellWidth: 20 }, 
        2: { cellWidth: 45 }, // Evento
        3: { halign: 'right', cellWidth: 22 }, // Monto
        4: { halign: 'center', cellWidth: 12 }, // Cuota
        5: { halign: 'right', cellWidth: 22 }, // Ganancia (Nueva!)
        6: { halign: 'center' } 
    },
    margin: { top: 30 }
});
    }
    // --- FIN DE LA HOJA 2 ---

    doc.save(`Reporte_Betflow_${textoPeriodo.replace(/ /g, '_')}.pdf`);
}

// Función del gráfico mejorada estéticamente
function crearImagenGrafico(datos) {
    return new Promise((resolve) => {
        const canvas = document.getElementById('tempChartCanvas');
        let acumulado = 0;
        const labels = datos.map(b => `M${b.nro_movimiento}`);
        const valores = datos.map(b => {
            const monto = parseFloat(b.dinero);
            acumulado += (b.resultados?.resultado === 'Ganador') ? (monto * parseFloat(b.cuota) - monto) : -monto;
            return acumulado;
        });

        const tempChart = new Chart(canvas, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Balance de Capital',
                    data: valores,
                    borderColor: '#2c3e50', // Gris oscuro profesional
                    backgroundColor: 'rgba(44, 62, 80, 0.05)', // Sombreado ligero
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3, // Curva suave
                    pointRadius: 2,
                    pointBackgroundColor: '#2c3e50'
                }]
            },
            options: {
                animation: false,
                devicePixelRatio: 2, // Mejora la resolución
                scales: {
                    y: { grid: { color: '#f0f0f0' } },
                    x: { grid: { display: false } }
                },
                plugins: { legend: { display: false } }
            }
        });

        setTimeout(() => {
            const imgData = canvas.toDataURL('image/png');
            tempChart.destroy();
            resolve(imgData);
        }, 600);
    });
}

    </script>
</body>
</html>