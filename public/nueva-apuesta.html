<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betflow - Nueva Apuesta</title>
    <style>
    :root {
        --primary: #007bff;
        --bg: #0f1113;
        --card-bg: #1a1d21;
        --border: #2d3139;
        --text-dim: #9ba1a6;
    }

    body { 
        font-family: 'Inter', sans-serif; 
        background: var(--bg); 
        color: white; 
        margin: 0;
        height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden; 
    }

    .form-container { 
width: 90%; /* Aumentamos el ancho relativo */
max-width: 1300px; /* Expandimos el l√≠mite horizontal */
height: 90%;        
max-height: 900px;
background: var(--card-bg); 
padding: 30px 45px; /* M√°s padding interno para que no se vea apretado */        border-radius: 12px; 
border-radius: 16px; 
    border: 1px solid var(--border);
    box-shadow: 0 10px 30px rgba(0,0,0,0.5); /* Sombra para darle profundidad */    }

    header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 12px; /* Menos margen */
        border-bottom: 1px solid var(--border);
        padding-bottom: 8px;
    }
    
    h2 { margin: 0; font-size: 1.2rem; color: var(--primary); }

.main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px 50px; /* Aumentamos el espacio entre columnas y filas */
    margin-top: 20px;
}

    .field-group {
        margin-top: 5px;
    border-color: var(--primary); /* Resaltar que es modo manual */ 
        display: flex; flex-direction: column; gap: 2px; 
    } /* Menos gap interno */
    
/* 3. Etiquetas m√°s legibles */
label { 
    font-size: 0.85rem; /* Un poco m√°s grandes */
    font-weight: 700; 
    color: var(--text-dim); 
    margin-bottom: 6px;
}    
select, input { 
    padding: 12px 16px; /* M√°s alto y aireado */
    border-radius: 8px; 
    border: 1px solid var(--border); 
    background: #212529; 
    color: white; 
    font-size: 1.1rem; /* Aumentamos el tama√±o de la letra para legibilidad */
    width: 100%;
    box-sizing: border-box;
    transition: all 0.2s ease;
}
select:focus, input:focus {
    border-color: var(--primary);
    background: #2a2e33;
    outline: none;
}

    .inline-check { font-size: 0.6rem; color: var(--text-dim); cursor: pointer; display: flex; align-items: center; gap: 4px; }
    
/* 5. Caja de ganancia m√°s destacada */
.ganancia-box { 
    grid-column: span 2;
    padding: 15px;
    font-size: 1.1rem;
    background: rgba(68, 255, 68, 0.1);
    border: 1px solid #44ff44;
}

   /* 4. Bot√≥n de Guardar imponente */
.btn-guardar { 
    grid-column: span 2;
    padding: 18px; /* Mucho m√°s alto */
    background: var(--primary); 
    color: white; 
    border: none; 
    border-radius: 8px; 
    font-weight: 700;
    font-size: 1.2rem; /* Letra m√°s grande */
    text-transform: uppercase;
    letter-spacing: 2px;
    cursor: pointer;
    margin-top: 25px;
    transition: transform 0.1s;
}

.btn-guardar:hover {
    background: #0056b3;
    transform: translateY(-2px);
}

    .hidden { display: none; }

@media (max-width: 768px) {
    /* 1. Ajuste del Contenedor Principal */
    body {
        align-items: flex-start;
        overflow-y: auto;
        padding: 0; /* Eliminamos bordes externos en m√≥vil */
    }

    .form-container {
        width: 100%;
        height: 100vh; /* Ocupa toda la pantalla */
        max-height: none;
        border-radius: 0; /* Se siente como una App nativa */
        padding: 20px;
        border: none;
    }

    /* 2. Header m√°s compacto */
    header {
        margin-bottom: 25px;
    }
    
    h2 { font-size: 1.3rem; }

    /* 3. Una sola columna real */
    .main-grid {
        display: flex;
        flex-direction: column;
        gap: 20px; /* M√°s espacio entre grupos para que no se choquen */
    }

    /* 4. Estilo de los Campos y Links */
    .field-group {
        width: 100%;
    }

    /* Alineamos el label y el link de forma m√°s limpia */
    .field-group > div:first-child {
        margin-bottom: 8px;
    }

    .action-link {
        background: rgba(0, 123, 255, 0.1); /* Un fondo sutil azul */
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.6rem;
        text-decoration: none !important;
    }

    /* 5. Inputs Grandes para dedos (Touch Friendly) */
    select, input {
        width: 100%;
        padding: 14px 12px !important; /* M√°s altos */
        font-size: 16px !important; /* Evita el zoom molesto en iPhone */
        background: #212529;
    }

    /* 6. Fila de Cuota y Monto */
    /* Para que estos dos no ocupen tanto espacio vertical, los ponemos juntos */
    .field-group:has(#input-cuota), 
    .field-group:has(#input-monto) {
        width: 100%;
    }

    /* 7. Bot√≥n de Guardar */
    .btn-guardar {
        margin-top: 10px;
        padding: 18px;
        font-size: 1.1rem;
        position: sticky; /* Se queda pegado abajo si el cel es chico */
        bottom: 0;
    }
}

.btn-volver:hover {
    color: var(--primary) !important;
    
}
.action-link {
    font-size: 0.65rem;
    color: var(--primary);
    cursor: pointer;
    text-transform: uppercase;
    font-weight: bold;
    opacity: 0.7;
    transition: opacity 0.3s;
}

.action-link:hover {
    opacity: 1;
    text-decoration: underline;
}

</style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <div class="form-container">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px;">
    <div style="display: flex; align-items: center; gap: 15px;">
        <a href="home.html" style="text-decoration: none; color: var(--text-dim); font-size: 1.5rem; line-height: 1;">‚Üê</a>
        <h2 style="margin: 0; font-size: 1.4rem; color: var(--primary);">Registrar Apuesta</h2>
    </div>
    <span id="label-movimiento" style="background: var(--border); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; color: var(--primary); font-weight: bold;">M--</span>
</header>
    
    <div class="main-grid">
        <div class="field-group">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <label>Deporte</label>
        <span class="action-link" onclick="toggleManualDirecto('deporte')">¬øNo aparece?</span>
    </div>
    <select id="select-deporte" onchange="actualizarDependientes()">
        <option value="">Selecciona...</option>
    </select>
    <input type="text" id="input-deporte-manual" class="hidden" placeholder="Escribir nuevo deporte...">
</div>

        <div class="field-group">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
        <label>Campeonato</label>
        <span class="action-link" onclick="toggleManualDirecto('campeonato')">¬øNuevo Campeonato?</span>
    </div>
    <select id="select-campeonato">
        <option value="">Selecciona...</option>
    </select>
    <input type="text" id="input-campeonato-manual" class="hidden" placeholder="Nombre de la Liga o Torneo">
</div>

<div class="field-group">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
        <label>Equipo Local</label>
        <span class="action-link" onclick="toggleManualDirecto('equipo-local')">¬øNo aparece?</span>
    </div>
    <select id="select-equipo-local">
        <option value="">Selecciona...</option>
    </select>
    <input type="text" id="input-equipo-local-manual" class="hidden" placeholder="Nombre del Equipo Local">
</div>

<div class="field-group">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
        <label>Equipo Visitante</label>
        <span class="action-link" onclick="toggleManualDirecto('equipo-visitante')">¬øNo aparece?</span>
    </div>
    <select id="select-equipo-visitante">
        <option value="">Selecciona...</option>
    </select>
    <input type="text" id="input-equipo-visitante-manual" class="hidden" placeholder="Nombre del Equipo Visitante">
</div>

<div class="field-group">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
        <label>Tipo de Apuesta</label>
        <span class="action-link" onclick="toggleManualDirecto('tipo-apuesta')">¬øNuevo Tipo?</span>
    </div>
    <select id="select-tipo-apuesta" onchange="actualizarOpciones()">
        <option value="">Selecciona...</option>
    </select>
    <input type="text" id="input-tipo-apuesta-manual" class="hidden" placeholder="Ej: Tiros de Esquina">
</div>

<div class="field-group">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
        <label>Opci√≥n Elegida</label>
        <span class="action-link" onclick="toggleManualDirecto('opcion')">¬øNueva Opci√≥n?</span>
    </div>
    <select id="select-opcion"> 
        <option value="">Selecciona...</option>
    </select>
    <input type="text" id="input-opcion-manual" class="hidden" placeholder="Ej: M√°s de 9.5">
</div>
        <div class="field-group">
            <label>Fecha del Evento</label>
            <input type="date" id="fecha-apuesta">
        </div>

        <div style="display: flex; gap: 10px;">
            <div class="field-group" style="flex: 1;">
                <label>Cuota</label>
                <input type="number" id="cuota" step="0.001" placeholder="1.90" oninput="calcularGanancia()">
            </div>
            <div class="field-group" style="flex: 1;">
                <label>Monto</label>
                <input type="number" id="monto" step="0.01" placeholder="500" oninput="calcularGanancia()">
            </div>
        </div>

        <div id="ganancia-box" class="ganancia-box hidden">
            Ganancia Potencial: <span>$<span id="valor-ganancia">0.00</span></span>
        </div>

        <button class="btn-guardar" onclick="guardarApuesta()">Guardar Apuesta</button>
    </div>
</div>

    <script>
// 1. Funci√≥n gen√©rica para ordenar alfab√©ticamente
function ordenarDatos(lista, propiedad) {
    if (!lista) return [];
    return lista.sort((a, b) => {
        const textoA = (a[propiedad] || "").toString().toLowerCase();
        const textoB = (b[propiedad] || "").toString().toLowerCase();
        return textoA.localeCompare(textoB);
    });
}
window.onload = async () => {
    const t0 = performance.now();
    const CACHE_KEY = 'betflow_recursos_cache';
    const TIME_KEY = 'betflow_cache_time';
    const selectDeporte = document.getElementById('select-deporte');
    
    const cacheExistente = localStorage.getItem(CACHE_KEY);
    const ultimoUpdate = localStorage.getItem(TIME_KEY);
    const ahora = Date.now();
    
    // Si el cache tiene menos de 10 minutos, no pedimos nada a la red (ahorro de Vercel)
    const cacheValido = ultimoUpdate && (ahora - ultimoUpdate < 10 * 60 * 1000);

    if (cacheExistente) {
        recursosGlobales = JSON.parse(cacheExistente);
        poblarSelectores(recursosGlobales); // Funci√≥n auxiliar para no repetir c√≥digo
        console.log("‚ö° Cargado desde Cache Local");
    }

    // Solo vamos a la red si el cache es viejo o no existe
    if (!cacheValido) {
        try {
            console.log("üåê Cache vencido o inexistente. Consultando Vercel...");
            const res = await fetch('/api/data/resources');
            const nuevosRecursos = await res.json();
            
            recursosGlobales = nuevosRecursos;
            localStorage.setItem(CACHE_KEY, JSON.stringify(nuevosRecursos));
            localStorage.setItem(TIME_KEY, ahora.toString());
            
            poblarSelectores(recursosGlobales);
            console.log("‚úÖ Datos actualizados desde Vercel");
        } catch (error) {
            console.error("Error en red:", error);
        }
    }
    
    await cargarSiguienteMovimiento();
};

// Funci√≥n auxiliar para mantener el c√≥digo limpio
function poblarSelectores(data) {
    const selectDeporte = document.getElementById('select-deporte');
    if (data.deportes) {
        const deportesOrdenados = ordenarDatos(data.deportes, 'nombre_deporte');
        selectDeporte.innerHTML = '<option value="">Selecciona...</option>';
        deportesOrdenados.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.id_deporte; 
            opt.textContent = d.nombre_deporte;
            selectDeporte.appendChild(opt);
        });
    }
}
function actualizarDependientes() {
    const deporteId = document.getElementById('select-deporte').value;
    const selectCamp = document.getElementById('select-campeonato');
    const selectEqLocal = document.getElementById('select-equipo-local');
    const selectEqVis = document.getElementById('select-equipo-visitante');
    const selectTipo = document.getElementById('select-tipo-apuesta');
    const selectOpcion = document.getElementById('select-opcion');

    // Limpiar selectores
    [selectCamp, selectEqLocal, selectEqVis, selectTipo, selectOpcion].forEach(s => {
        if(s) s.innerHTML = '<option value="">Selecciona...</option>';
    });

    if (!deporteId) return;

    // 1. Llenar Campeonatos (Ordenados)
    if (recursosGlobales.campeonatos) {
        const filtrados = recursosGlobales.campeonatos.filter(c => (c.id_deporte || c.deporte_id) == deporteId);
        ordenarDatos(filtrados, 'nombre_campeonato').forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id_campeonato || c.id;
            opt.textContent = c.nombre_campeonato || c.nombre;
            selectCamp.appendChild(opt);
        });
    }

    // 2. Llenar Equipos (Ordenados)
    if (recursosGlobales.equipos) {
        const filtrados = recursosGlobales.equipos.filter(e => (e.id_deporte || e.deporte_id) == deporteId);
        // Usamos 'nombre' como propiedad de orden
        ordenarDatos(filtrados, 'nombre').forEach(e => {
            const id = e.id_equipo || e.id;
            const optL = document.createElement('option');
            optL.value = id; optL.textContent = e.nombre;
            selectEqLocal.appendChild(optL);

            const optV = optL.cloneNode(true);
            selectEqVis.appendChild(optV);
        });
    }

    // 3. Llenar Tipos (Ordenados)
    if (recursosGlobales.tipo_apuestas) {
        const filtrados = recursosGlobales.tipo_apuestas.filter(t => (t.id_deporte || t.deporte_id) == deporteId);
        ordenarDatos(filtrados, 'tipo').forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id_tipo || t.id;
            opt.textContent = t.tipo || t.nombre;
            selectTipo.appendChild(opt);
        });
    }
}
function actualizarOpciones() {
    const tipoId = document.getElementById('select-tipo-apuesta').value;
    const selectOpcion = document.getElementById('select-opcion');
    selectOpcion.innerHTML = '<option value="">Selecciona...</option>';

    if (!tipoId || !recursosGlobales.opciones) return;

    const filtrados = recursosGlobales.opciones.filter(o => (o.id_tipo) == tipoId);
    ordenarDatos(filtrados, 'opcion').forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.id_opciones || o.id;
        opt.textContent = o.opcion || o.nombre;
        selectOpcion.appendChild(opt);
    });
}
async function cargarSiguienteMovimiento() {
    const userId = localStorage.getItem('userId') || 2;
    try {
        const res = await fetch(`/api/bets/historial/${userId}?page=0&size=1`);
        const result = await res.json();
        // totalCount es un campo com√∫n en respuestas paginadas de Supabase
        const proximoM = (result.totalCount || 0) + 1;
        const badge = document.getElementById('label-movimiento'); // Aseg√∫rate de tener este ID
        if(badge) badge.innerText = `M${proximoM}`;
    } catch (e) {
        console.error("Error calculando Nro Movimiento");
    }
}

function toggleManual(tipo) {
    // Buscamos los elementos por su ID din√°mico
    const checkbox = document.getElementById(`check-${tipo}-manual`);
    const inputTexto = document.getElementById(`input-${tipo}-manual`);
    const selectLista = document.getElementById(`select-${tipo}`);

    if (checkbox.checked) {
        // MODO MANUAL ACTIVADO
        inputTexto.classList.remove('hidden'); // Mostramos el campo de texto
        selectLista.disabled = true;           // Inhabilitamos la lista
        selectLista.value = "";                // Limpiamos la selecci√≥n de la lista
    } else {
        // MODO LISTA ACTIVADO
        inputTexto.classList.add('hidden');    // Escondemos el campo de texto
        inputTexto.value = "";                 // Limpiamos lo que se escribi√≥
        selectLista.disabled = false;          // Habilitamos la lista
    }
}
function toggleManualDirecto(tipo) {
    const select = document.getElementById(`select-${tipo}`);
    const input = document.getElementById(`input-${tipo}-manual`);
    const link = event.target; 

    if (input.classList.contains('hidden')) {
        // ACTIVAR MODO MANUAL
        input.classList.remove('hidden');
        select.classList.add('hidden');
        select.value = ""; // Limpia la selecci√≥n para evitar conflictos al guardar
        link.innerText = "Volver a lista";
        link.style.color = "#9ba1a6"; // Color gris (text-dim)
    } else {
        // VOLVER A MODO LISTA
        input.classList.add('hidden');
        input.value = ""; // Limpia lo escrito
        select.classList.remove('hidden');
        link.innerText = "¬øNo aparece?";
        link.style.color = "#007bff"; // Color azul (primary)
    }
}
function calcularGanancia() {
    // Capturamos los valores
    const cuotaInput = document.getElementById('cuota');
    const montoInput = document.getElementById('monto');
    
    const cuota = parseFloat(cuotaInput.value) || 0;
    const monto = parseFloat(montoInput.value) || 0;
    const box = document.getElementById('ganancia-box');
    const valorGanancia = document.getElementById('valor-ganancia');

    // REGLA 4: Cuota positiva, no cero, no excesiva (ej: max 1000)
    const cuotaValida = cuota > 1 && cuota < 1000;
    
    // REGLA 5: Monto positivo y m√°ximo 2 decimales
    const montoValido = monto > 0 && /^\d+(\.\d{1,2})?$/.test(montoInput.value);

    if (cuotaValida && montoValido) {
        const total = (cuota * monto).toFixed(2);
        valorGanancia.innerText = total;
        box.style.background = "#004d40"; // Color verde √©xito
        box.classList.remove('hidden');
        return true; 
    } else {
        box.classList.add('hidden');
        return false;
    }
}
async function guardarApuesta() {
    console.log("Iniciando proceso de guardado...");
    
    try {
        const auth_id_actual = localStorage.getItem('supabase_auth_id'); 

        if (!auth_id_actual) {
            alert("‚ö†Ô∏è Sesi√≥n no encontrada. Por favor reingresa.");
            return;
        }

        const obtenerValor = (tipo) => {
            const select = document.getElementById(`select-${tipo}`);
            const inputManual = document.getElementById(`input-${tipo}-manual`);
            
            if (select && select.classList.contains('hidden')) {
                return inputManual ? inputManual.value.trim() : "";
            }
            return (select && select.value !== "") ? select.options[select.selectedIndex].text.trim() : "";
        };

        // IDs CORREGIDOS para coincidir con tu HTML
        const datos = {
            auth_id: auth_id_actual, 
            deporte: document.getElementById('select-deporte').options[document.getElementById('select-deporte').selectedIndex]?.text || "",
            campeonato: obtenerValor('campeonato'),
            equipo_local: obtenerValor('equipo-local'),
            equipo_visitante: obtenerValor('equipo-visitante'),
            tipo_apuesta: obtenerValor('tipo-apuesta'),
            opcion_elegida: obtenerValor('opcion'),
            fecha: document.getElementById('fecha-apuesta').value, // ID corregido
            cuota: parseFloat(document.getElementById('cuota').value), // ID corregido
            monto: parseFloat(document.getElementById('monto').value)  // ID corregido
        };

        if (!datos.deporte || !datos.equipo_local || isNaN(datos.cuota) || isNaN(datos.monto)) {
            alert("‚ö†Ô∏è Por favor completa Deporte, Local, Cuota y Monto correctamente.");
            return;
        }

        const res = await fetch('/api/apuestas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        });

        const resultado = await res.json();

        if (res.ok) {
            alert("‚úÖ " + (resultado.message || "Movimiento registrado!"));
            window.location.href = "home.html";
        } else {
            throw new Error(resultado.error || "Error al procesar en el servidor");
        }

    } catch (error) {
        console.error("‚ùå Error en guardarApuesta:", error.message);
        alert("Error: " + error.message);
    }
}    </script>
</body>
</html>
