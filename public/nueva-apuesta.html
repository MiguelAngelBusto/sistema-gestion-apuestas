<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betflow - Nueva Apuesta</title>
    <style>
        body { font-family: sans-serif; background: #121212; color: white; padding: 20px; }
        .form-container { max-width: 500px; margin: auto; background: #1e1e1e; padding: 2rem; border-radius: 12px; }
        .field-group { margin-bottom: 1.5rem; display: flex; flex-direction: column; }
        label { margin-bottom: 0.5rem; color: #007bff; font-weight: bold; }
        select, input { padding: 10px; border-radius: 4px; border: 1px solid #333; background: #2a2a2a; color: white; }
        .inline-check { display: flex; align-items: center; gap: 10px; font-size: 0.8rem; margin-top: 5px; color: #aaa; }
        .hidden { display: none; }
        .ganancia-potencial { margin-top: 1rem; padding: 10px; background: #004d40; border-radius: 4px; text-align: center; font-weight: bold; }
        .btn-guardar { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="form-container">
        <h2>Registrar Apuesta</h2>
        
        <div class="field-group">
            <label>Deporte</label>
            <select id="select-deporte" onchange="actualizarDependientes(); toggleManual('deporte')">
                <option value="">Selecciona un deporte...</option>
                </select>
            <div class="inline-check">
                <input type="checkbox" id="check-deporte-manual" onchange="toggleManual('deporte')">
                <span>No está en la lista (Cargar nuevo)</span>
            </div>
            <input type="text" id="input-deporte-manual" class="hidden" placeholder="Nombre del nuevo deporte">
        </div>
        <div class="field-group">
    <label>Campeonato</label>
    <select id="select-campeonato" onchange="toggleManual('campeonato')">
        <option value="">Selecciona un campeonato...</option>
    </select>
    <div class="inline-check">
        <input type="checkbox" id="check-campeonato-manual" onchange="toggleManual('campeonato')">
        <span>Nuevo Campeonato</span>
    </div>
    <input type="text" id="input-campeonato-manual" class="hidden" placeholder="Nombre del campeonato">
</div>

<div class="field-group">
    <label>Equipo Local</label>
    <select id="select-equipo-local">
        <option value="">Selecciona equipo local...</option>
    </select>

    <div class="inline-check">
        <input type="checkbox" id="check-equipo-local-manual" onchange="toggleManual('equipo-local')">
        <span>Nuevo Equipo (Local)</span>
    </div>

    <input type="text" id="input-equipo-local-manual" class="hidden" placeholder="Escribe el nombre del equipo local">
</div>

<div class="field-group">
    <label>Equipo Visitante</label>
    <select id="select-equipo-visitante">
        <option value="">Selecciona equipo visitante...</option>
    </select>

    <div class="inline-check">
        <input type="checkbox" id="check-equipo-visitante-manual" onchange="toggleManual('equipo-visitante')">
        <span>Nuevo Equipo (Vis)</span>
    </div>

    <input type="text" id="input-equipo-visitante-manual" class="hidden" placeholder="Escribe el nombre del equipo">
</div>
<div class="field-group">
    <label>Tipo de Apuesta (ej: 1x2, Goles)</label>
    <select id="select-tipo-apuesta" onchange="actualizarOpciones(); toggleManual('tipo-apuesta')">
        <option value="">Selecciona tipo...</option>
    </select>
    <div class="inline-check">
        <input type="checkbox" id="check-tipo-apuesta-manual" onchange="toggleManual('tipo-apuesta')">
        <span>Nuevo Tipo</span>
    </div>
    <input type="text" id="input-tipo-apuesta-manual" class="hidden" placeholder="Ej: Total de Goles">
</div>

<div class="field-group">
    <label>Opción Elegida (ej: Local, +2.5)</label>
    <select id="select-opcion"> 
        <option value="">Selecciona opción...</option>
    </select>
    <div class="inline-check">
        <input type="checkbox" id="check-opcion-manual" onchange="toggleManual('opcion')">
        <span>Nueva Opción</span>
    </div>
    <input type="text" id="input-opcion-manual" class="hidden" placeholder="Ej: Más de 2.5">
</div>
        <div class="field-group">
            <label>Fecha del Evento</label>
            <input type="date" id="fecha-apuesta">
        </div>

        <div style="display: flex; gap: 10px;">
            <div class="field-group" style="flex: 1;">
                <label>Cuota</label>
                <input type="number" id="cuota" step="0.001" min="1.001" placeholder="Ej: 1.325" oninput="calcularGanancia()">
            </div>
            <div class="field-group" style="flex: 1;">
                <label>Monto</label>
                <input type="number" id="monto" step="0.01" min="0.01" placeholder="Ej: 500.00" oninput="calcularGanancia()">
            </div>
        </div>

        <div id="ganancia-box" class="ganancia-potencial hidden">
            Ganancia Potencial: $<span id="valor-ganancia">0.00</span>
        </div>

        <button class="btn-guardar" onclick="guardarApuesta()">Guardar Apuesta</button>
    </div>

    <script>
window.onload = async () => {
    // Usamos las llaves que ya conocemos
    const _url = 'https://svxohzuimappgarlrdmj.supabase.co';
    const _key = 'sb_publishable_i7RoPGZJBH94idhLllNgWg_lepex86i';
    
    // Inicializamos supabaseApp usando el constructor de la librería (window.supabase)
    if (window.supabase) {
        supabaseApp = window.supabase.createClient(_url, _key);
        console.log("✅ Betflow: Cliente inicializado sin conflictos.");
    }

    // Tu lógica de carga de recursos...
    try {
        const res = await fetch('/api/data/resources');
        recursosGlobales = await res.json();
        
        const selectDeporte = document.getElementById('select-deporte');
        if (recursosGlobales.deportes) {
            recursosGlobales.deportes.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.id_deporte; 
                opt.textContent = d.nombre_deporte;
                selectDeporte.appendChild(opt);
            });
        }
    } catch (error) {
        console.error("Error cargando recursos:", error);
    }
};

function actualizarDependientes() {
    const deporteId = document.getElementById('select-deporte').value;
    
    // Selectores a limpiar
    const selectCamp = document.getElementById('select-campeonato');
    const selectEqLocal = document.getElementById('select-equipo-local');
    const selectEqVis = document.getElementById('select-equipo-visitante');
    const selectTipo = document.getElementById('select-tipo-apuesta');
    const selectOpcion = document.getElementById('select-opcion');

    // Limpiar todos los selectores dependientes
    [selectCamp, selectEqLocal, selectEqVis, selectTipo, selectOpcion].forEach(s => {
        if(s) s.innerHTML = '<option value="">Selecciona...</option>';
    });

    if (!deporteId) return;

    // 1. Llenar Campeonatos
    if (recursosGlobales.campeonatos) {
        const campsFiltrados = recursosGlobales.campeonatos.filter(c => (c.id_deporte || c.deporte_id) == deporteId);
        campsFiltrados.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.id_campeonato || c.id;
            opt.textContent = c.nombre_campeonato || c.nombre;
            selectCamp.appendChild(opt);
        });
    }

    // 2. Llenar Equipos (Local y Visitante)
    if (recursosGlobales.equipos) {
        const eqsFiltrados = recursosGlobales.equipos.filter(e => (e.id_deporte || e.deporte_id) == deporteId);
        eqsFiltrados.forEach(e => {
            const id = e.id_equipo || e.id;
            const nombre = e.nombre;
            
            const optL = document.createElement('option');
            optL.value = id; optL.textContent = nombre;
            selectEqLocal.appendChild(optL);

            const optV = document.createElement('option');
            optV.value = id; optV.textContent = nombre;
            selectEqVis.appendChild(optV);
        });
    }

    // 3. Llenar Tipos de Apuesta (Ej: 1x2, Goles)
    if (recursosGlobales.tipo_apuestas) {
        const tiposFiltrados = recursosGlobales.tipo_apuestas.filter(t => (t.id_deporte || t.deporte_id) == deporteId);
        tiposFiltrados.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id_tipo || t.id;
            opt.textContent = t.tipo || t.nombre;
            selectTipo.appendChild(opt);
        });
    }
}

function actualizarOpciones() {
    const tipoId = document.getElementById('select-tipo-apuesta').value;
    const selectOpcion = document.getElementById('select-opcion');
    
    // Limpiar opciones previas
    selectOpcion.innerHTML = '<option value="">Selecciona...</option>';

    if (!tipoId || !recursosGlobales.opciones) return;

    // Filtrar opciones por el ID del tipo de apuesta seleccionado
    const opcionesFiltradas = recursosGlobales.opciones.filter(o => (o.id_tipo) == tipoId);
    
    opcionesFiltradas.forEach(o => {
        const opt = document.createElement('option');
        opt.value = o.id_opciones || o.id;
        opt.textContent = o.opcion || o.nombre;
        selectOpcion.appendChild(opt);
    });
}
function toggleManual(tipo) {
    // Buscamos los elementos por su ID dinámico
    const checkbox = document.getElementById(`check-${tipo}-manual`);
    const inputTexto = document.getElementById(`input-${tipo}-manual`);
    const selectLista = document.getElementById(`select-${tipo}`);

    if (checkbox.checked) {
        // MODO MANUAL ACTIVADO
        inputTexto.classList.remove('hidden'); // Mostramos el campo de texto
        selectLista.disabled = true;           // Inhabilitamos la lista
        selectLista.value = "";                // Limpiamos la selección de la lista
    } else {
        // MODO LISTA ACTIVADO
        inputTexto.classList.add('hidden');    // Escondemos el campo de texto
        inputTexto.value = "";                 // Limpiamos lo que se escribió
        selectLista.disabled = false;          // Habilitamos la lista
    }
}

function calcularGanancia() {
    // Capturamos los valores
    const cuotaInput = document.getElementById('cuota');
    const montoInput = document.getElementById('monto');
    
    const cuota = parseFloat(cuotaInput.value) || 0;
    const monto = parseFloat(montoInput.value) || 0;
    const box = document.getElementById('ganancia-box');
    const valorGanancia = document.getElementById('valor-ganancia');

    // REGLA 4: Cuota positiva, no cero, no excesiva (ej: max 1000)
    const cuotaValida = cuota > 1 && cuota < 1000;
    
    // REGLA 5: Monto positivo y máximo 2 decimales
    const montoValido = monto > 0 && /^\d+(\.\d{1,2})?$/.test(montoInput.value);

    if (cuotaValida && montoValido) {
        const total = (cuota * monto).toFixed(2);
        valorGanancia.innerText = total;
        box.style.background = "#004d40"; // Color verde éxito
        box.classList.remove('hidden');
        return true; 
    } else {
        box.classList.add('hidden');
        return false;
    }
}
async function guardarApuesta() {
    console.log("Iniciando proceso de guardado...");
    
    try {
        // 1. Verificar sesión de Supabase
        const { data: { session }, error: sessionError } = await supabaseApp.auth.getSession();

        if (sessionError || !session) {
            alert("Error: No se detecta una sesión activa. Por favor, reingresa.");
            return;
        }

        const auth_id_actual = session.user.id;

        // 2. Función interna robusta para recolectar datos
        const obtenerValor = (tipo) => {
            const checkbox = document.getElementById(`check-${tipo}-manual`);
            const isManual = checkbox ? checkbox.checked : false;

            if (isManual) {
                const input = document.getElementById(`input-${tipo}-manual`);
                return input ? input.value.trim() : "";
            } else {
                const select = document.getElementById(`select-${tipo}`);
                if (select && select.selectedIndex !== -1) {
                    // Si la opción seleccionada es la de "Selecciona...", devolvemos vacío
                    if (select.value === "") return "";
                    return select.options[select.selectedIndex].text.trim();
                }
                return "";
            }
        };

        // 3. Construcción del objeto de datos
        const datos = {
            deporte: obtenerValor('deporte'),
            campeonato: obtenerValor('campeonato'),
            equipo_local: obtenerValor('equipo-local'),
            equipo_visitante: obtenerValor('equipo-visitante'),
            tipo_apuesta: obtenerValor('tipo-apuesta'),
            opcion_elegida: obtenerValor('opcion'),
            fecha: document.getElementById('fecha-apuesta').value,
            cuota: parseFloat(document.getElementById('cuota').value),
            monto: parseFloat(document.getElementById('monto').value),
            auth_id: auth_id_actual,
            movimiento: 1 // Según tu instrucción: "añadir 1 para cada apuesta, esta es M1"
        };

        // 4. Validaciones básicas antes de enviar
        if (!datos.deporte || !datos.equipo_local || !datos.monto || !datos.cuota || !datos.fecha) {
            alert("Por favor, completa todos los campos obligatorios.");
            console.log("Datos incompletos:", datos);
            return;
        }

        if (isNaN(datos.cuota) || isNaN(datos.monto)) {
            alert("La cuota y el monto deben ser números válidos.");
            return;
        }

        // 5. Envío al Backend
        const res = await fetch('/api/apuestas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        });

        const resultado = await res.json();

        if (res.ok) {
            alert("✅ " + resultado.message);
            window.location.href = "home.html";
        } else {
            alert("❌ Error: " + (resultado.error || "No se pudo guardar la apuesta"));
        }

    } catch (error) {
        console.error("Error crítico en guardarApuesta:", error);
        alert("Ocurrió un error inesperado. Revisa la consola.");
    }
}

    </script>
</body>
</html>